/**
 * Script para inicializar o estoque baseado nos dados reais de produ√ß√£o
 */

const BASE_URL = 'http://localhost:3000';

async function inicializarEstoqueReal() {
  console.log('üîÑ Inicializando estoque com dados reais...\n');

  try {
    // 1. Buscar todas as mat√©rias-primas cadastradas
    console.log('1Ô∏è‚É£ Buscando mat√©rias-primas cadastradas...');
    const mpRes = await fetch(`${BASE_URL}/api/db/getMateriaPrima`);
    const materiasPrimas = await mpRes.json();
    console.log(`‚úÖ ${materiasPrimas.length} mat√©rias-primas encontradas`);

    // 2. Buscar dados de produ√ß√£o para calcular consumo
    console.log('\n2Ô∏è‚É£ Analisando dados de produ√ß√£o...');
    const rowsRes = await fetch(`${BASE_URL}/api/relatorio/paginate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ params: { page: 1, pageSize: 1000 } })
    });
    const rowsData = await rowsRes.json();
    console.log(`‚úÖ ${rowsData.rows.length} batidas de produ√ß√£o encontradas`);

    // 3. Calcular consumo m√©dio por mat√©ria-prima
    const consumoPorMateria = new Map();
    
    for (const row of rowsData.rows) {
      if (!row.values) continue;
      
      for (let i = 0; i < row.values.length; i++) {
        const quantidade = row.values[i];
        if (quantidade && quantidade > 0) {
          if (!consumoPorMateria.has(i)) {
            consumoPorMateria.set(i, { total: 0, batidas: 0 });
          }
          const stats = consumoPorMateria.get(i);
          stats.total += quantidade;
          stats.batidas++;
        }
      }
    }

    console.log(`‚úÖ ${consumoPorMateria.size} mat√©rias-primas com consumo registrado`);

    // 4. Inicializar estoque para cada mat√©ria-prima com dados reais
    console.log('\n3Ô∏è‚É£ Inicializando estoque...');
    let inicializados = 0;
    
    for (const mp of materiasPrimas) {
      const consumo = consumoPorMateria.get(mp.num);
      
      if (consumo) {
        const mediaPorBatida = consumo.total / consumo.batidas;
        
        // Estoque inicial: suficiente para 60 dias de produ√ß√£o
        // Assumindo 50 batidas/dia em m√©dia
        const quantidadeInicial = Math.round(mediaPorBatida * 50 * 60);
        
        // M√≠nimo: 7 dias de produ√ß√£o
        const minimo = Math.round(mediaPorBatida * 50 * 7);
        
        // M√°ximo: 90 dias de produ√ß√£o
        const maximo = Math.round(mediaPorBatida * 50 * 90);

        try {
          const initRes = await fetch(`${BASE_URL}/api/estoque/inicializar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              materiaPrimaId: mp.id,
              quantidadeInicial,
              minimo,
              maximo
            })
          });

          if (initRes.ok) {
            inicializados++;
            const produtoNome = mp.produto || `MP${mp.num}`;
            console.log(`   ‚úÖ ${produtoNome}: ${quantidadeInicial}kg (min: ${minimo}, max: ${maximo})`);
          }
        } catch (err) {
          console.log(`   ‚ö†Ô∏è Erro ao inicializar ${mp.produto || mp.num}: ${err.message}`);
        }
      } else {
        // Para mat√©rias sem consumo, inicializar com valores padr√£o baixos
        try {
          const initRes = await fetch(`${BASE_URL}/api/estoque/inicializar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              materiaPrimaId: mp.id,
              quantidadeInicial: 1000,
              minimo: 100,
              maximo: 5000
            })
          });

          if (initRes.ok) {
            inicializados++;
            console.log(`   ‚ÑπÔ∏è ${mp.produto || `MP${mp.num}`}: 1000kg (sem hist√≥rico de consumo)`);
          }
        } catch (err) {
          console.log(`   ‚ö†Ô∏è Erro ao inicializar ${mp.produto || mp.num}: ${err.message}`);
        }
      }
    }

    console.log(`\n‚úÖ ${inicializados} estoques inicializados com sucesso!`);

    // 5. Registrar algumas movimenta√ß√µes de exemplo
    console.log('\n4Ô∏è‚É£ Registrando movimenta√ß√µes de exemplo...');
    
    const mpComConsumo = Array.from(consumoPorMateria.keys()).slice(0, 5);
    for (const numMateria of mpComConsumo) {
      const mp = materiasPrimas.find(m => m.num === numMateria);
      if (!mp) continue;

      // Entrada
      await fetch(`${BASE_URL}/api/estoque/entrada`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          materiaPrimaId: mp.id,
          quantidade: 5000,
          responsavel: 'Sistema',
          observacoes: 'Entrada inicial autom√°tica'
        })
      });

      // Sa√≠da
      await fetch(`${BASE_URL}/api/estoque/saida`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          materiaPrimaId: mp.id,
          quantidade: 1500,
          responsavel: 'Sistema',
          observacoes: 'Consumo produ√ß√£o autom√°tico'
        })
      });

      console.log(`   ‚úÖ Movimenta√ß√µes criadas para ${mp.produto || `MP${mp.num}`}`);
    }

    // 6. Verificar estat√≠sticas finais
    console.log('\n5Ô∏è‚É£ Verificando estat√≠sticas...');
    const estatRes = await fetch(`${BASE_URL}/api/estoque/estatisticas`);
    const estatisticas = await estatRes.json();
    
    console.log('\nüìä ESTAT√çSTICAS FINAIS:');
    console.log(`   Total de itens: ${estatisticas.totalItens}`);
    console.log(`   Itens abaixo do m√≠nimo: ${estatisticas.itensAbaixoMinimo}`);
    console.log(`   Itens acima do m√°ximo: ${estatisticas.itensAcimaMaximo}`);
    console.log(`   Taxa de rota√ß√£o: ${estatisticas.taxaRotacao.toFixed(2)}x`);

    console.log('\n‚úÖ Inicializa√ß√£o conclu√≠da com sucesso!');
    console.log('\nüìä Acesse: http://localhost:5173/estoque-management');

  } catch (error) {
    console.error('\n‚ùå Erro durante a inicializa√ß√£o:', error.message);
    console.error('\nüí° Certifique-se de que o backend est√° rodando: npm run dev');
  }
}

// Executar
inicializarEstoqueReal();
